---
title: "headliner"
author: "Jake Riley 6/14/22"
#institute: "RStudio, PBC"
date: "[.header-link[slides]](https://github.com/pages/rjake/talks-and-presentations/.../README.html) 
| [.header-link[code]](https://github.com/rjake/talks-and-presentations/.../README.md)"
output:
  # github_document: default # comment this out for moon-reader to work
  xaringan::moon_reader:
    css: xaringan-themer.css
    # css: [default, hygge, ninjutsu]
    lib_dir: libs
    nature:
      ratio: 16:9
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
knit:
  (function(inputFile, encoding) {
    rmarkdown::render(inputFile, encoding = encoding, output_dir = ".", output_format = "all")
   }
  )
---

```{css css-extra, echo=FALSE}
.title-slide {
  vertical-align: bottom !important;
  text-align: left !important;
  background-image: url(figures/logo-dark.png);
  background-size: 440px;
}

.header-link {
  color: #E6E6E6;
}

.remark-inline-code {
  background-color: #E6E6E6;
}

.large { font-size: 130% }
.small { font-size: 70% }

.small .remark-code { font-size: 90%}
```


```{r css-theme, include=FALSE, eval=FALSE}
# don't need to run each time, just on changes
library(xaringanthemer)
library(simplecolors)

xaringanthemer::style_mono_light(
  
  table_row_even_background_color = "transparent",
  
  #code_font_size = "1.3em",
  code_highlight_color = sc("grey2"),
  
  code_inline_color = "black",
  #code_inline_font_size = "1.3em",
  code_inline_background_color = sc("grey2"),
  
  header_background_padding = "0px",
  header_background_content_padding_top = "0px",
  link_decoration = "underline",
  text_font_family = xaringanthemer_font_default("text_font_family")
)
```


```{r workspace, include=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(
  fig.width = 9, fig.height = 3.5, fig.retina = 3,
  comment = "",
  message = FALSE,
  warning = FALSE,
  hiline = TRUE
)

library(tidyverse)
library(headliner)
library(simplecolors)
library(flair)
library(glue)
library(gt)
library(flipbookr)


registerS3method(
  genname = "knit_print",
  class = "with_flair",
  method = knit_print.with_flair,
  envir = asNamespace("knitr")
)


highlight_colors <- simplecolors::sc_across(light = 1, return = "table")

hl <- 
  set_names(
    x = highlight_colors$hex,
    nm = str_remove(highlight_colors$color_name, "muted|\\d")
  ) |> 
  as.list() |> 
  append(c(grey3 = sc("grey3")))


gt_custom <- function(df) {
  gt(df) |>
    tab_style(
      style = 
        "padding-right:15px; padding-bottom:5px;
         padding-left: 15px; padding-top:   5px;",
      locations = cells_body()
    )
}
```

## About Me

.pull-left[
.large[

* Clinical Data Analyst

<br>
* Data viz/maps
    - Tableau, Qlik, R

<br>
* R Package Development
    - `simplecolors`
    - `shinyobjects`
    - **`headliner`**
    
]
]

.pull-right[
![](figures/chop.png)

<br><br><br>

![](figures/pkgs.png)
]

---


## Building an insightful dashboard is not easy

.pull-left[
 ### Facts
 
 * Easy out of the box
 * Risk of low adoption


 ### Insights
 
 * More meaningful
 * Risk of high technical debt
]

.pull-right[

<img src="figures/insights.png" height="500px" style="position:absolute;right:100px;top:130px;">
]

---

## What's a good title for this chart?

.pull-left[
#### Monthly downloads...
* **...by month**
  * static, vague, no insight, no lift

* ...changed from **3.4M** to **1.1M**
  * somewhat dynamic, low insight, light lift

* ...**decreased** by **67%** (**1.1M** vs **3.4M**)
  * very dynamic, good insight, heavy lift
]

.pull-right[
![](figures/cran-magrittr.png)
]


---

## Enter `headliner`

.pull-left[
<!-- .center[] -->

* `headliner` is an R packaged focused on informative titles <br>
<img src="figures/logo.png" height="120px">


* Given two values, `headliner` gives metadata about the difference

```{r eval=TRUE, echo=FALSE}
decorate(as_glue(
"
headline(32, 24)
#> increase of 8 (32 vs. 24)


headline(24, 32)
#> decrease of 8 (24 vs. 32)
"
)) |> 
  flair_rx("..crease")
```

]

.pull-right[
```{r, echo=FALSE, eval=TRUE}
compare_values(24, 32) |> 
  view_list() |> 
  rownames_to_column() |>
  select(value = value, name = rowname) |> 
  mutate(name = paste0("{", name, "}")) |> 
  gt_custom() |> 
  tab_options(column_labels.hidden = TRUE) |> 
  tab_style(
    style = cell_text(font = google_font(name = "Space Mono")),
    locations = cells_body(name)
  ) |> 
  tab_header(
    title = md("**Talking Points**"),
    subtitle = md("`compare_values(24, 32) |> view_list()`")
  ) |> 
  fmt_markdown(columns = everything()) |> 
  cols_align("right", value) #|> cols_width(everything() ~ px(150))

```
]


---

## Using `glue()` under the hood

.pull-left[
```{r eval=TRUE}
my_age <- 37

glue("I am {my_age}")

headline(
  x = 24, 
  y = 32,
  "{article_delta}pt {trend} ({orig_values})"
)
```
]

.pull-right[
```{r eval=TRUE}
compare_values(24, 32) |> 
  view_list() 
```
]

---

##

```{r headline-basic, echo=FALSE}
headline(
  x = 8:12,
  y = 12:8,
  headline = 
    "There was {article_delta_p}% {trend} ({x} vs {y})"
)
```

```{r, echo=FALSE, eval=TRUE}
decorate("headline-basic") |> 
  flair_rx("\\{[^\\}]*\\}") |> 
  flair_rx("#.*", color = hl$grey3)
```

---

##

```{r, echo=FALSE}
headline_anatomy <- as_glue(
'headline(
  x = 8:12,
  y = 12:8,
  headline = 
    "There was {article_delta_p}% {trend} ({orig_values})"
)'
)
```

```{r}
print(headline_anatomy)
```

```{r echo=FALSE, eval=TRUE}
decorate(headline_anatomy) |> 
  flair_rx("x = .*")

decorate(headline_anatomy) |> 
  flair_rx("y = .*")

decorate(headline_anatomy) |> 
  flair_rx("headline = .*")
```

---
## In action with `ggtext`

.center[
  ![cran downloads in facets](figures/cran-pkgs.png)
]

---

## Another example

.center[
  <img src="figures/pixar-plots.png">

]

---

## How we've used it at CHOP

.center[
 <img src="figures/exec-report-story-points.png" width="75%" height="75%">
]

---

## How we've used it at CHOP

.center[
 <img src="figures/exec-report-inpatient-detail.png">
]

---

##
.pull-left[
.small[
```{r eval=FALSE}
# return just the name of the look back month
month_lookback <- function(n) {
  floor_date(
    x = Sys.Date() - months(n),
    unit = "month"
  ) |>
    month(
      label = TRUE,
      abbr = FALSE
    )
}


make_adc_headlines <- function() {
  headline( # last month ADC vs 2 months ago ADC
    x = adc(1), 
    y = adc(2),
    headline = 
      "The average midnight daily census for {month_lookback(1)} was 
      {blue(x)}, a {delta}-point {trend} 
      since {month_lookback(2)}'s end-of-month ADC of {y}. "
  ) +
    headline( # last month ADC vs last month Budget
      x = adc(1), 
      y = budget(1),
      headline = 
        "This is {blue(delta)} ({round(delta_p)}%) {trend} 
        the budgeted {month_lookback(1)} ADC of {y}.",
      trend_phrases = trend_terms("above", "below")
    )
}

```
]
]

.pull-right[
The average midnight daily census for **May** was **___**, a **14**-point **increase** since **April**â€™s end-of-month ADC of **___**. This is **___** (**8**%) **above** the budgeted **May** ADC of **___**.
]
---

##

```{r}

```

---

##

```{r}

```

---

##

```{r}

```

---

##

```{r}

```

---

##

```{r}

```

---

##

```{r}

```

---

##

```{r}

```

---

## exit
```{r exit, eval=TRUE}
knitr::knit_exit()
```

---

`r chunk_reveal("my_cars", title = "## flipbookr")`

```{r my_cars,  eval = F, echo = F}
 cars %>%
   filter(speed > 4) %>%
   ggplot() +
   aes(x = speed) + #BREAK
   aes(y = dist) + #BREAK
   geom_point(
     alpha = .8, 
     color = "blue" 
     ) + 
   aes(size = speed) #BREAK
```

---


`r chunk_reveal("my_fill", break_type = "rotate", widths = c(1,1), title = "### cycle through lines w/ #ROTATE")`

```{r my_fill, eval = F, echo = F}
ggplot(data = cars) +
  aes(x = speed) +
  aes(y = dist) +
  geom_point(
    size = 8,
    shape = 21,
    alpha = .9,
    color = "snow"
  ) +
  aes(fill = speed) +
  scale_fill_viridis_c(option = "magma") + # ROTATE
  scale_fill_viridis_c(option = "cividis") + # ROTATE
  scale_fill_viridis_c(option = "plasma") # ROTATE
```
 
---
